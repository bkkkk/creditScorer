---
title: "Exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(randomForest)
library(readr)
library(dplyr)
library(ggplot2)
library(scales)

source("R/func-NA.R")
source("R/func-clean.R")
source("R/01-load.R")
source("R/02-clean.R")
```

## Problem statement

Given a large data set of client financial information, attempt to determine if a given client will default on their payment. In this case the default payment is defined as failing to make a payment 90 days after the due date.

## Dataset

Two datasets were used for this study one for training and one for testing with `r nrow(raw_tr)` and `r nrow(raw_tr)` entries respectively. Each set includes 10 predictors, with the training set also including a response variable. These include information about the borrower's income, age, and number of dependants; number of lines of credit; and how many times the borrower missed a due date by as much as 60, 90, or more than 90 days. The full list of variables is included at the end of the report.

The training dataset contains `r sum(nacols(raw_tr))` predictors with missing values, namely `r nacols_name(raw_tr)` with `r sum(is.na(raw_tr))` entries in the dataset containing missing values.

Specifically, `r nacol_percent(raw_tr$MonthlyIncome)`% of the monthly income data is missing while `r nacol_percent(raw_tr$NumberOfDependents)` of the entries are missing the measurement of the number of dependents.

## Data exploration

A data summary shows that the dataset contains a wide range of borrowers in age (21 to 109), income (no income to 3 million), and number of dependants (upto 20).

The dataset contains an overwhelming majority of negative examples, `r 100*mutate(count(clean_tr, seriousDlqin), occ = n/sum(n))$occ[1]`% of the data corresponds to clients who have not failed to make a payment within 90 days of the due date in the last two years.

### Age

As mentioned before the borrowers in the data represent a wide cross-section of the population. The age distribution shows that borrows as young as 21 and as old as 90+ are included in the dataset.

```{r age-dirty}
clean_tr %>%
  ggplot(aes(age, fill = seriousDlqin)) +
  geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Applicant Age",
       x = "Age",
       y = "")
```

A single entry in the dataset was a misrecorded with an age of zero. This was corrected to the median age for the rest of the analysis.

```{r age-clean}
clean_tr %>%
  clean_credit_score_age() %>%
  ggplot(aes(age, fill = seriousDlqin)) + geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() + 
  theme(legend.position = "bottom") +
  labs(title = "Applicant Age",
       x = "Age",
       y = "")
```

### Number of Dependents

This variable describes the number of dependants registered under the borrower. As expected, the majority of borrowers have less than 3 dependants, with the number of borrowers decreasing rapidly with number of dependants. There are a number of 

```{r number-of-deps}
clean_tr %>%
  ggplot(aes(seriousDlqin, nDependents)) + geom_boxplot() +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Number of Dependants",
       x = "Defaulted on payment?",
       y = "Number of Dependants")
```

As mentioned before about 2% of the entries have no information about the number of dependants. At this point this data is simply ignored, no attempt is made to infer this missing data.

### Times borrowers 30-59 days past due date

This variables describes the number of times the borrower has failed to pay 30 to 59 days past the due date but no more.

```{r past-due-30-dirty}
clean_tr %>%
  ggplot(aes(pastDue30, fill = seriousDlqin)) + geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Times Past Due (30-59 Days)",
       # subtitle = "Distribution bulk",
       x = "Times Past Due",
       y = "")
```

This variable contains a few entries at 96 and 98, these are likely encodings for missing values or other special cases. A value of 96 or 98 in one pastDue variable coincides with 96 or 98 value in the other two pastDue variables. 5 out of all borrowers in the data have a status code 96, while 264 have a past due value code of 98. Having these values be the same across pastDue variables suggest these are status codes. These are likely associated with borrowers that refused to provide the information or are new to the company collecting the data.

Since these observations make up a small portion of the data, the status codes were simply replaced with the median of the rest of the pastDue distribution.

```{r past-due-30-cleam}
clean_tr %>%
  clean_credit_score_pastDue30() %>%
  ggplot(aes(pastDue30, fill = seriousDlqin)) + geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Times Past Due (30-59 Days)",
       # subtitle = "Distribution bulk",
       x = "Times Past Due",
       y = "")
```

### Times borrowers 60-89 days past due date

Similar to the aforementioned variable except for a period of 60 to 89 past the due date and no more.

```{r past-due-60-dirty}
clean_tr %>%
  ggplot(aes(pastDue60, fill = seriousDlqin)) + geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Times Past Due (60-89 Days)",
       x = "Times Past Due",
       y = "")
```

We take the same procedure here to remove entries with value 96 and 98.

```{r past-due-60-clean}
clean_tr %>%
  clean_credit_score_pastDue60() %>%
  ggplot(aes(pastDue60, fill = seriousDlqin)) + geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Times Past Due (60-89 Days)",
       x = "Times Past Due",
       y = "")
```

### Times more than 90 days past due

The number of times the borrower has failed to make a payment 90 days past the due date.

```{r}
clean_tr %>%
  ggplot(aes(pastDue90, fill = seriousDlqin)) + geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Times Past Due (90+ Days)",
# subtitle = "Distribution bulk",
       caption = "source: www.kaggle.com",
       x = "Times Past Due",
       y = "")
```

We take the same procedure here to remove entries with value 96 and 98.

```{r past-due-90-clean}
clean_tr %>%
  clean_credit_score_pastDue90() %>%
  ggplot(aes(pastDue90, fill = seriousDlqin)) + geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Times Past Due (90+ Days)",
       caption = "source: www.kaggle.com",
       x = "Times Past Due",
       y = "")
```


### Number of Credit lines and Loans

This is the number of credit lines and loans associated with the borrower.

```{r}
clean_tr %>%
  ggplot(aes(nCreditsAndLoans, fill = seriousDlqin)) + geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Number of Credits and Loans",
       caption = "source: www.kaggle.com",
       x = "Credits and Loans",
       y = "")
```

This distribution is surprisingly well behaved following and almost gaussian distribution. There appear to be a few outlier entries with some borrowers having as many as 50+ loans and credit lines. Without any specific domain knowledge to suggest these should be removed, these entries will be left in.

### Number of estate loans and credit lines

The number of estate loans and credit lines associated with the borrower.

The distribution is fairly well-behaved but contains a long tail with some borrowers having as many as 20 estate loans or lines of credit. Without any specific domain knowledge to suggest how to deal with these, the choice was made to leave these in the data.

```{r}
clean_tr %>%
  ggplot(aes(nEstateLoansOrLines, fill = seriousDlqin)) + geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Number of Estate Loans or Lines",
       caption = "source: www.kaggle.com",
       x = "Loans and Lines",
       y = "")
```


### Monthly Income

The monthly income as the name suggest is the monthly income of the borrower. The range of values here is quite surprising, there are numerous borrowers with incomes in the millions. Given the range of values it is impossible to assume which currency is being used in the measurement. Shown below is only the bulk of the distribution.

```{r monthly-income-bulk}
clean_tr %>%
  select(seriousDlqin, monthlyIncome) %>%
  na.omit() %>%
  ggplot(aes(monthlyIncome, fill = seriousDlqin)) +
  geom_histogram() +
  xlim(-1, 30000) +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Monthly Income",
       # subtitle = "Distribution Bulk",
       caption = "source: www.kaggle.com",
       x = "Monthly Income",
       y = "")
```

Interestingly, it seems that the borrowers who did default on their payment tend to be in the low monthly income section of the disribution. This makes sense since, having more income makes paying for loans easier.

The dataset also includes `r sum(clean_tr$monthlyIncome > 30000, na.rm = T)` high-earners with monthly incomes over 30000.

Interestingly, there also seems to be two peaks at zero and 1 incomes, as can been seen from the distribution below this does not fit the rest of the distribution. It is hard to suggest what could be happening here. This could be mismeasurement where some records are simply missing but were not marked as N/A, another possibility is that 0 and 1 are used as dummy codes. Finally, it is possible that some people simply have no income at all. If there were borrowers with no income one would expect a smooth tail towards zero, having a large peak at zero is highly suspect.

```{r}
clean_tr %>%
  select(seriousDlqin, monthlyIncome) %>%
  na.omit() %>%
  ggplot(aes(monthlyIncome, fill = seriousDlqin)) +
  geom_histogram(binwidth = 1) +
  xlim(-2, 400) +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  #theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Monthly Income",
       # subtitle = "Distribution Bulk",
       caption = "source: www.kaggle.com",
       x = "Monthly Income",
       y = "")
```

Let us examine these cases more closely, starting with age and number of dependants. Nothing in the age distribution suggests that this is a specific kind of borrower.

```{r zero-income-age}
clean_tr %>%
  filter(monthlyIncome == 0) %>%
  ggplot(aes(age, fill = seriousDlqin)) +
  geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  #theme_hrbrmstr() + 
  theme(legend.position = "bottom") +
  labs(title = "Age, No Income",
       # subtitle = "No Income",
       caption = "source: www.kaggle.com",
       x = "Age",
       y = "")
```

The number of dependants also appears normal with no particular section of the population that has no income.

```{r zero-income-ndependants}
clean_tr %>%
  filter(monthlyIncome == 0) %>%
  ggplot(aes(nDependents, fill = seriousDlqin)) +
  geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  #theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Number of Dependants, No Income",
       # subtitle = "No Income",
       caption = "source: www.kaggle.com",
       x = "Age",
       y = "")
```

### Debt Ratio

The debt ratio is defined as the ratio of total monthly debt payments to total monthly income. This distribution exhibits a strange shape, below unity the distribution appears to be somewhat well-behaved. The majority of borrowers use a certain portion of their monthly income to pay for debt. However there is a second part of the population that have a debt ratio in the 1000s. So what is going on here?

```{r debt-ratio-dirty}
clean_tr %>%
  select(seriousDlqin, debtRatio) %>%
  ggplot(aes(debtRatio, fill = seriousDlqin)) +
  geom_histogram() +
  geom_vline(xintercept  = 1) +
  scale_x_log10() +
  theme(legend.position = "") +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  #theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Debt Ratio",
       subtitle = "Bulk",
       caption = "source: www.kaggle.com",
       x = "Monthly Income",
       y = "")
```

The debt ratio is closely related to the monthly income variable, which contains a number of high-earners, some potentially suspect entries at no income, and about 20% missing entries.

First, removing the missing values substaintially reduces the number of borrowers which have a larger than 1 debt ratio suggesting that there is some interplay between missing values and the higher than expected debt ratios.

It is possible that the debt ratio is calculated using the recorded monthly income, and in the cases where this value is missing some imputation procedure is used that results in extremely high debt ratios. For example, it's possible that all missing monthly incomes were replaced with unity in the debt ratio calculation and the entries in the distribution are actually the debt amount rather than the debt ratio.

```{r debt-ratio-no-na}
clean_tr %>%
  filter(!is.na(monthlyIncome)) %>%
  select(seriousDlqin, debtRatio) %>%
  ggplot(aes(debtRatio, fill = seriousDlqin)) +
  geom_histogram(binwidth = 0.02) +
  geom_vline(xintercept  = 1) +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  #theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Debt Ratio",
       subtitle = "Bulk",
       caption = "source: www.kaggle.com",
       x = "Monthly Income",
       y = "")
```

Sanitizing the data further by removing entries with no income also reduces the population at very high debt ratios. In this case however there is less justification for doing so. It is possible for borrowers to have no income at all, though again a peak at exactly zero with little occupancy in the adjacent bins is suspect.

```{r debt-ratio-no-na-more1}
clean_tr %>%
  filter(!is.na(monthlyIncome)) %>%
  select(seriousDlqin, debtRatio) %>%
  ggplot(aes(debtRatio, fill = seriousDlqin)) +
  geom_histogram(binwidth = 0.02) +
  geom_vline(xintercept  = 1) +
  theme(legend.position = "") +
  xlim(0, 1.5) +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  #theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Debt Ratio",
       # subtitle = "Distribution Bulk",
       caption = "source: www.kaggle.com",
       x = "Debt Ratio",
       y = "")
```

Without a clear understanding of the relationship between debt ratio and monthly income, imputation of the monthly income variables is no possible. It is thus decided that entries with missing monthly incomes will simply be dropped.

### Revolving utilization of unsecured credit lines

This is a measure of the credit balance as a portion of the total credit limit, this is presented as a percentage. Measurements should therefore lie between 0% and 100%. Shown below is the bulk of the distribution but once again note that there are large outliers here above this range.

```{r}
clean_tr %>%
  ggplot(aes(fill = seriousDlqin, unsecuredUtil)) + geom_histogram() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  #theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  scale_x_continuous(labels = percent, limits = c(0, 1.5)) +
  labs(title = "Credit Balance over Credit Limit",
       # subtitle = "Total balance on personal lines of credit over credit limit",
       caption = "source: www.kaggle.com",
       x = "Percentage of Credit Limit",
       y = "")
```

Removing these outliers once again requires some domain knowledge to do correctly particularly since it likely interacts with other values in the dataset.

```{r}

```






| Name | Desc | Type |
| SeriousDlqin2yrs | Person experienced 90 days past due delinquency or worse | boolean |
| RevolvingUtilizationOfUnsecuredLines | Total Balan ||
