---
title: "Exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(randomForest)
library(readr)
library(dplyr)
library(ggplot2)
library(scales)

source("R/func-NA.R")
source("R/func-clean.R")
source("R/01-load.R")
source("R/02-clean.R")
```

## Problem statement

Given a large data set of client financial information, attempt to determine if a given client will default on their payment. In this case the default payment is defined as failing to make a payment 90 days after the due date.

## Dataset

Two datasets were used for this study one for training and one for testing with `r nrow(raw_tr)` and `r nrow(raw_tr)` entries respectively. Each set includes 10 predictors, with the training set also including a response variable. These include information about the borrower's income, age, and number of dependants; number of lines of credit; and how many times the borrower missed a due date by as much as 60, 90, or more than 90 days. The full list of variables is included at the end of the report.

The training dataset contains `r sum(nacols(raw_tr))` predictors with missing values, namely `r nacols_name(raw_tr)` with `r sum(is.na(raw_tr))` entries in the dataset containing missing values.

Specifically, `r nacol_percent(raw_tr$MonthlyIncome)`% of the monthly income data is missing while `r nacol_percent(raw_tr$NumberOfDependents)` of the entries are missing the measurement of the number of dependents.

## Data exploration

A data summary shows that the dataset contains a wide range of borrowers in age (21 to 109), income (no income to 3 million), and number of dependants (upto 20).

The dataset contains an overwhelming majority of negative examples, `r 100*mutate(count(clean_tr, seriousDlqin), occ = n/sum(n))$occ[1]`% of the data corresponds to clients who have not failed to make a payment within 90 days of the due date in the last two years.

### Age

As mentioned before the borrowers in the data represent a wide cross-section of the population. The age distribution shows that borrows as young as 21 and as old as 90+ are included in the dataset.

```{r age-dirty}
clean_tr %>%
  ggplot(aes(age, fill = seriousDlqin)) +
  geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Applicant Age",
       x = "Age",
       y = "")
```

A single entry in the dataset was a misrecorded with an age of zero. This was corrected to the median age for the rest of the analysis.

```{r age-clean}
clean_tr %>%
  clean_credit_score_age() %>%
  ggplot(aes(age, fill = seriousDlqin)) + geom_bar() +
  scale_fill_brewer(name = "Delinquent Past Due", type = "qual", palette = "Set1") +
  # theme_hrbrmstr() + 
  theme(legend.position = "bottom") +
  labs(title = "Applicant Age",
       x = "Age",
       y = "")
```

### Number of Dependents

This variable describes the number of dependants registered under the borrower. As expected, the majority of borrowers have less than 3 dependants, with the number of borrowers decreasing rapidly with number of dependants. There are a number of 

```{r number-of-deps}
clean_tr %>%
  ggplot(aes(seriousDlqin, nDependents)) + geom_boxplot() +
  # theme_hrbrmstr() +
  theme(legend.position = "bottom") +
  labs(title = "Number of Dependants",
       x = "Defaulted on payment?",
       y = "Number of Dependants")
```

As mentioned before about 2% of the entries have no information about the number of dependants. At this point this data is simply ignored, no attempt is made to infer this missing data.

```{r}
nacols <- function(df) {
  unlist(lapply(df, function(x) any(is.na(x))))
}

nacols_name <- function(df) {
  colnames(df)[nacols(df)]
}
```

## Problem statement

Given a large data set of client financial information, attempt to determine if a given client will default on their payment.

## Dataset

```{r}
training <- read_csv("./data/cs-training.csv")
training <- training %>%
  select(seriousDqlin = SeriousDlqin2yrs,
         age = age,
         nDependants = NumberOfDependents,
         monthlyIncome = MonthlyIncome,
         debtRatio = DebtRatio,
         pastDue30 = `NumberOfTime30-59DaysPastDueNotWorse`,
         pastDue60 = `NumberOfTime60-89DaysPastDueNotWorse`,
         pastDue90 = NumberOfTimes90DaysLate,
         revolvingUtil = RevolvingUtilizationOfUnsecuredLines,
         openLines = NumberOfOpenCreditLinesAndLoans,
         realEstateLines = NumberRealEstateLoansOrLines
  )


```

Two datasets were used for this study one for training and one for testing with `r nrow(training)` and `r nrow(testing)` entries respectively. Each set includes 10 predictors, with the training set also including a response variable. These include information about the borrower's income, age, and number of dependants; number of lines of credit; and how many times the borrower missed a due date by as much as 60, 90, or more than 90 days. The full list of variables is included at the end of the report.

The training dataset contains `r sum(nacols(training))` predictors with missing values, namely `r nacols_name(training)` with `r sum(is.na(training))` entries in the dataset containing missing values. Missing values are very prevalent and should be considered in the rest of the study.

## Data summary and potential outliers

A data summary shows that the dataset contains a wide range of borrowers in age (21 to 109), income (no income to 3 million), and number of dependants (upto 20).

Some potential outlier cases in the data include a borrower with a monthly income of 3 million, another with 20 dependants, and a borrower with a recorded age of zero. The last case is likely a misrecorded event. As expected these are not typical cases as distributions below show: 

```{r}
training %>%
  ggplot(aes(nDependants)) + geom_bar()

training %>%
  ggplot(aes(age)) + geom_bar()
```

The dataset includes `r sum(na.omit(training$monthlyIncome)>1000000)` entries with a monthly income about 1 million

##



## Variable list

| Name | Desc | Type |
| SeriousDlqin2yrs | Person experienced 90 days past due delinquency or worse | boolean |
| RevolvingUtilizationOfUnsecuredLines | Total Balan ||
